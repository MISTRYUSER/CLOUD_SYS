好的，下面我将结合 `README.md` 及源码结构，对云盘项目的技术栈和实现细节做更详细的梳理，便于你面试前系统复习。

---

# 云盘项目技术栈与实现细节（详细版）

## 一、技术栈

### 1. 编程语言与开发环境
- **主要语言**：C语言
- **开发环境**：Linux（Ubuntu），命令行开发
- **编译工具**：Makefile 自动化构建

### 2. 网络与通信
- **Socket编程**：实现客户端与服务器端的TCP通信
- **自定义协议**：采用TLV（Type-Length-Value）格式，支持多种命令（如CD、LS、PUTS、GETS等）

### 3. 并发与高性能
- **线程池**：pthread库实现，主线程负责监听和分发，工作线程处理具体任务
- **任务队列**：生产者-消费者模型，主线程投递任务，工作线程取任务执行
- **I/O多路复用**：epoll机制，支持高并发连接，提升I/O效率

### 4. 数据存储
- **数据库**：MySQL，存储用户信息、文件元数据、目录结构
- **MySQL C API**：直接用C语言操作数据库，参数化SQL防止注入

### 5. 文件系统
- **虚拟文件系统**：支持多级目录、文件分块、文件哈希
- **大文件传输**：分块上传/下载，支持断点续传和秒传（基于哈希）

### 6. 安全性
- **密码加盐哈希**：注册时生成随机盐，SHA1加密后存储
- **SQL注入防护**：所有数据库操作均用参数化查询
- **会话管理**：客户端超时检测，自动断开无响应连接

---

## 二、系统架构

### 1. 服务器端
- 负责监听客户端连接，分发任务到线程池
- 处理用户认证、文件/目录操作、数据库交互
- 维护任务队列和线程池，保证高并发下的稳定性

### 2. 客户端
- 命令行交互界面，支持注册、登录、上传、下载、目录切换等操作
- 负责与服务器通信，解析服务器响应

### 3. 通信协议
- **TLV格式**：每条消息包含类型（Type）、长度（Length）、值（Value）
- **命令类型**：如CD（切换目录）、LS（列目录）、PUTS（上传）、GETS（下载）、REMOVE（删除）等
- **请求-响应模式**：客户端发起请求，服务器处理后返回结果

---

## 三、核心功能模块与实现细节

### 1. 用户管理系统
- **注册**：生成20位随机盐，SHA1加密密码，用户名、盐、加密密码存入数据库
- **登录**：根据用户名查找盐，客户端输入密码后加盐SHA1加密，与数据库比对
- **注销/退出**：更新数据库状态，清理会话

### 2. 文件管理系统
- **上传**：
  - 客户端分块读取文件，计算每块哈希
  - 服务器端接收分块，重组文件
  - 支持秒传：若哈希已存在，直接生成文件记录，无需重复上传
- **下载**：
  - 客户端请求文件，服务器分块发送
  - 支持断点续传
- **删除**：
  - 删除数据库记录和实际文件
  - 支持回收站或彻底删除

### 3. 目录管理系统
- **多级目录**：每个目录有唯一ID和父ID，支持嵌套
- **切换目录**：维护线程局部目录栈，支持cd ..、cd /等操作
- **创建/删除目录**：数据库中插入/删除目录记录，支持递归删除
- **列出目录内容**：查询当前目录下所有文件和子目录

### 4. 并发与任务调度
- **线程池**：主线程监听连接，任务投递到任务队列
- **任务队列**：循环队列实现，互斥锁+条件变量保证线程安全
- **工作线程**：从队列取任务，处理客户端请求

### 5. 文件传输优化
- **mmap内存映射**：大文件读写采用mmap提升效率
- **分块传输**：每块独立校验，支持大文件和断点续传
- **哈希秒传**：同一文件多次上传只需一次物理存储

### 6. 安全与健壮性
- **加盐哈希**：防止彩虹表攻击
- **参数化SQL**：防止SQL注入
- **超时检测**：客户端长时间无响应自动断开
- **错误处理**：所有操作有详细错误码和日志

---

## 四、项目结构（源码分布）

```
cloud-drive/
├── client/             # 客户端代码
│   ├── tlv.c          # TLV协议实现
│   ├── header.h       # 头文件
│   ├── my_libs.h      # 库函数声明
│   └── client_logic.c # 客户端主逻辑
├── server/             # 服务器端代码
│   ├── Makefile       # 编译脚本
│   ├── func_cd.c      # 目录切换功能
│   ├── func_db.c      # 数据库操作
│   ├── func_dir.c     # 目录操作
│   ├── func_file.c    # 文件操作
│   ├── func_ls.c      # 目录列表功能
│   ├── thread_pool.c  # 线程池实现
│   ├── task_queue.c   # 任务队列实现
│   ├── password_auth_server.c # 用户认证
│   ├── header.h       # 头文件
│   ├── main.c         # 服务器主程序
│   └── my_libs.h      # 库函数声明
```

---

## 五、面试复习建议

# 云盘项目技术栈与实现细节笔记

以下是对云盘项目的技术栈、架构设计、核心功能模块实现细节及源码结构的全面总结，融合了项目概述和源码深度讲解内容，旨在为学习、开发和面试准备提供清晰、系统的参考。

---

## 项目概述

这是一个基于C/S架构的云存储系统，支持用户验证和文件管理功能。系统分为客户端和服务器端，使用TLV（Type-Length-Value）协议通信，MySQL存储用户信息和文件元数据。项目采用C语言开发，运行于Linux环境，注重高并发、高性能和安全性。

---

## 技术栈

### 1. 编程语言与开发环境
- **语言**：C语言
- **环境**：Linux（Ubuntu），命令行开发
- **工具**：Makefile 自动化构建

### 2. 网络与通信
- **Socket编程**：基于TCP的socket API实现客户端-服务器通信
- **TLV协议**：
  - 格式：类型（2字节）、长度（2字节）、值（可变长度）
  - 支持命令如CD、LS、PUTS、GETS等
- **通信模式**：请求-响应，长连接

### 3. 并发与高性能
- **线程池**：
  - 使用pthread库，默认5个工作线程（WORKER_NUM）
  - 主线程监听连接，工作线程处理业务逻辑
- **任务队列**：
  - 链表实现的生产者-消费者模型
  - 头删尾插，FIFO策略
  - 互斥锁和条件变量确保线程安全
- **I/O多路复用**：
  - epoll机制，边缘触发（ET）模式
  - 支持大量并发连接

### 4. 数据存储
- **数据库**：MySQL，存储用户、文件元数据和目录结构
  - 使用MySQL C API
  - 参数化查询防SQL注入
- **数据表**：
  - users：用户名、盐值、加密密码
  - files：文件ID、文件名、所有者、父目录ID、哈希值、路径、类型

### 5. 文件系统
- **虚拟文件系统**：
  - 支持多级目录，根目录ID为1
  - 支持相对/绝对路径
- **文件传输**：
  - 大文件分块（默认4KB）
  - SHA1哈希校验，支持秒传
  - 支持上传、下载、删除

### 6. 安全性
- **密码管理**：
  - 20位随机盐，SHA1加盐哈希
  - 客户端计算哈希比对
- **SQL防护**：参数化查询
- **会话管理**：
  - 线程本地存储（Thread Local Storage）
  - 超时检测

---

## 系统架构

### 1. 服务器端架构
```
+---------------------------+
|        Main Thread        |
|  (socket listen & epoll)  |
+---------------------------+
            |
            v
+---------------------------+
|       Task Queue          |
| (FIFO queue with locks)   |
+---------------------------+
            |
            v
+--------+--------+--------+
| Worker | Worker | Worker |
| Thread | Thread | Thread |
+--------+--------+--------+
            |
            v
+---------------------------+
|      Database Layer       |
|   (MySQL connection)      |
+---------------------------+
            |
            v
+---------------------------+
|  File System Operations   |
+---------------------------+
```

- **主线程**：
  - 初始化socket、线程池、数据库
  - epoll监听客户端连接
  - 分发任务到任务队列
- **工作线程**：
  - 从任务队列取命令
  - 执行文件操作、数据库查询
  - 返回结果

### 2. 客户端架构
- **交互层**：命令行界面
- **通信层**：TLV数据包发送/接收
- **处理层**：解析响应，显示结果

### 3. TLV协议命令
- TLV_TYPE_CD（2）：切换目录
- TLV_TYPE_LS（3）：列目录
- TLV_TYPE_PUTS（13）：上传文件
- TLV_TYPE_GETS（14）：下载文件
- TLV_TYPE_USERLOGIN（10）：登录
- TLV_TYPE_CHUNK_DATA（16）：分块数据
- 其他：注册、注销、删除等

---

## 核心功能模块实现细节

### 1. 用户管理系统
- **注册**：
  1. 客户端发送用户名+密码
  2. 服务器检查用户名是否存在
  3. 生成20位随机盐，SHA1加密密码
  4. 存储到users表
- **登录**：
  1. 客户端发送用户名
  2. 服务器返回盐值
  3. 客户端加密密码后发送
  4. 服务器验证，设置会话状态
- **注销**：
  - 标记用户删除，保留文件

### 2. 文件管理系统
- **上传（file_puts）**：
  1. 检查权限和父目录
  2. 计算SHA1哈希，查重（秒传）
  3. 分块上传（4KB/块）
  4. 存储元数据到files表
- **下载（file_gets）**：
  1. 验证权限
  2. 分块发送，支持断点续传
- **删除（file_remove）**：
  1. 验证权限
  2. 删除数据库记录
  3. 无引用时删除物理文件

### 3. 目录管理系统
- **创建（dir_mkdir）**：
  - 检查父目录，生成目录ID
  - 写入数据库和物理目录
- **列目录（dir_ls）**：
  - 查询子目录和文件
  - 格式化输出
- **切换（dir_cd）**：
  - 支持“..”、“.”、绝对/相对路径
  - 更新目录栈和current_pwd_id

### 4. 线程池与任务队列
- **线程池**：
  ```c
  int thread_init(thread_pool_t *pool, int worker_num) {
      tid_arr_init(&pool->tid_arr, worker_num);
      task_queue_init(&pool->task_queue);
      pthread_mutex_init(&pool->mutex, NULL);
      pthread_cond_init(&pool->cond, NULL);
      pool->exit_flag = KEEP;
      return 0;
  }
  ```
  - worker线程循环取任务，处理长命令
  - 支持优雅退出
- **任务队列**：
  ```c
  int en_queue(task_queue_t *queue, long_command_t cmd) {
      node_t *node = malloc(sizeof(node_t));
      node->long_command = cmd;
      if (queue->size == 0) {
          queue->front = queue->rear = node;
      } else {
          queue->rear->next = node;
          queue->rear = node;
      }
      queue->size++;
      return 0;
  }
  ```

### 5. 数据库交互
- **防注入**：
  ```c
  int fetch_string_by_username(MYSQL *mysql, const char *query, const char *username, char *result, size_t size) {
      MYSQL_STMT *stmt = mysql_stmt_init(mysql);
      mysql_stmt_prepare(stmt, query, strlen(query));
      MYSQL_BIND bind[1] = {{.buffer_type = MYSQL_TYPE_STRING, .buffer = (char*)username, .buffer_length = strlen(username)}};
      mysql_stmt_bind_param(stmt, bind);
      mysql_stmt_execute(stmt);
      MYSQL_BIND result_bind[1] = {{.buffer_type = MYSQL_TYPE_STRING, .buffer = result, .buffer_length = size - 1}};
      mysql_stmt_bind_result(stmt, result_bind);
      int ret = mysql_stmt_fetch(stmt) == 0 ? SUCCESS : ERR_DB;
      mysql_stmt_close(stmt);
      return ret;
  }
  ```

### 6. 文件操作优化
- **内存映射**：
  ```c
  int file_upload_with_mmap(const char *path, size_t size, const char *content) {
      int fd = open(path, O_RDWR | O_CREAT, 0664);
      ftruncate(fd, size);
      void *mapped = mmap(NULL, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);
      memcpy(mapped, content, size);
      msync(mapped, size, MS_SYNC);
      munmap(mapped, size);
      close(fd);
      return 0;
  }
  ```
- **秒传**：
  - 计算SHA1哈希，查重后直接添加引用

---

## 源码实现深度讲解

### 1. 主流程（main.c）
- 初始化线程池、数据库、socket
- epoll监听客户端连接和退出信号
- 短命令主线程处理，长命令投递线程池
- 定时检测超时连接

### 2. 线程池（thread_pool.c）
- 结构体：`tid_arr`、`task_queue`、锁、条件变量
- worker线程循环处理任务，支持优雅退出

### 3. TLV协议（tlv.c）
- `tlv_packet_t`封装命令
- `send_tlv`/`recv_tlv`处理粘包/拆包
- `tlv_unpack`解析命令类型和数据

### 4. 用户管理（password_auth_server.c）
- 注册/登录分步处理
- 盐值生成、密码加密
- 参数化SQL防注入

### 5. 文件管理（func_file.c）
- 上传：SHA1查重、mmap写入、元数据存储
- 下载：mmap读取、断点续传
- 删除：引用计数管理

### 6. 目录管理（func_dir.c/func_ls.c）
- 数据库维护树形结构
- 线程独立目录栈
- 详细SQL和异常处理

### 7. 数据库与安全
- `db_query`封装参数化查询
- 日志辅助调试

### 8. 异常处理
- 资源分配均有释放逻辑
- 任务队列、线程池、数据库支持优雅销毁
- 详细错误码和日志

### 9. 可维护性
- 模块化设计，功能分文件
- `header.h`统一声明
- 详细注释

---

## 项目结构

```
cloud-drive/
├── client/
│   ├── client_logic.c      # 客户端逻辑
│   ├── tlv.c              # TLV协议
│   ├── password_auth_client.c # 用户认证
│   ├── header.h           # 头文件
│   ├── my_libs.h          # 公共库
│   └── Makefile
├── server/
│   ├── main.c             # 主程序
│   ├── thread_pool.c      # 线程池
│   ├── task_queue.c       # 任务队列
│   ├── func_cd.c          # 目录切换
│   ├── func_ls.c          # 列目录
│   ├── func_dir.c         # 目录操作
│   ├── func_file.c        # 文件操作
│   ├── func_db.c          # 数据库操作
│   ├── password_auth_server.c # 用户认证
│   ├── solve_command.c    # 命令分发
│   ├── long_solve_command.c # 长命令处理
│   ├── tlv.c              # TLV协议
│   ├── header.h           # 头文件
│   ├── my_libs.h          # 公共库
│   └── Makefile
```

---

## 面试要点

以下是基于云盘项目的技术细节，预测的面试常见问题及详细回答，帮助展示项目深度和个人能力。

### 技术选型与设计

1. **为什么选择TLV协议而不是HTTP？**
    - **回答**：TLV协议简单灵活，适合自定义命令和数据格式，二进制传输效率高。HTTP虽成熟，但对轻量级自定义协议需求不必要复杂。本项目需要高效传输和解析，TLV更合适。
2. **epoll的ET模式和LT模式有什么区别？为什么选ET模式？**
    - **回答**：LT（水平触发）模式下，epoll在数据可读时持续通知；ET（边缘触发）模式仅在状态变化时通知。ET模式减少不必要唤醒，适合高性能场景，但需一次性读完数据。项目中选ET模式以提升并发性能。
3. **线程池大小如何确定？**
    - **回答**：线程池大小与CPU核心数和任务类型相关。项目默认5个线程，适合I/O密集型任务，可根据负载调整。过多线程增加切换开销，过少无法充分利用资源。

### 并发与性能

4. **如何实现高并发支持？**
    - **回答**：使用epoll管理大量连接，线程池处理并发任务，任务队列解耦生产者和消费者。短命令主线程处理，长命令异步投递，避免阻塞。
5. **生产者-消费者模型在项目中的应用？**
    - **回答**：主线程作为生产者，将长命令放入任务队列；工作线程作为消费者，取出任务处理。这种设计提高响应速度和资源利用率。

### 数据库与文件系统

6. **如何防止SQL注入？**
    - **回答**：所有数据库操作使用参数化查询，避免拼接用户输入。例如，使用 MYSQL_STMT 和 mysql_stmt_bind_param 绑定参数，确保安全。
7. **文件上传的秒传如何实现？**
    - **回答**：上传前计算文件的SHA1哈希，查询数据库是否已有相同哈希文件。若存在，直接添加引用（秒传）；否则存储新文件并记录元数据。
8. **大文件上传和下载如何优化？**
    - **回答**：分块传输（4KB/块）减少内存占用，使用 mmap 读写文件减少拷贝，支持断点续传提升体验。

### 安全性与会话管理

9. **用户密码如何加密存储？**
    - **回答**：注册时生成20位随机盐，密码加盐后SHA1加密存储。登录时客户端使用盐加密密码，服务器验证，防止彩虹表攻击。
10. **如何管理多用户会话状态？**
    - **回答**：每个客户端连接有独立结构体（如 client_state_t）存储状态，工作线程使用 _Thread_local 维护会话信息，确保线程安全。

### 异常处理与资源管理

11. **如何处理资源泄露？**
    - **回答**：所有动态分配资源（如内存、文件句柄、数据库连接）在异常分支中释放。线程池和任务队列支持优雅退出，确保清理。
12. **如何进行错误处理和日志记录？**
    - **回答**：定义详细错误码，关键操作前后记录日志到文件或控制台，便于调试和监控。

### 项目优化与扩展

13. **如何优化数据库性能？**
    - **回答**：可引入数据库连接池减少连接开销，对热门文件元数据进行内存缓存，减少查询。
14. **如何实现负载均衡？**
    - **回答**：部署多台服务器，使用负载均衡器分发请求，数据库可采用主从复制或分片提升容量。
15. **如何监控服务器性能？**
    - **回答**：集成监控工具，实时统计连接数、任务队列长度、CPU/内存使用率，设置告警机制及时处理异常。

---

## 项目亮点与技术难点

### 设计亮点

- **高并发**：epoll + 线程池 + 任务队列。
- **大文件处理**：分块传输 + mmap。
- **秒传**：SHA1去重。
- **安全性**：加盐哈希 + 参数化SQL。

### 技术难点

- **线程安全**：使用 _Thread_local 管理会话。
- **并发模型**：生产者-消费者解耦。
- **资源管理**：确保动态资源释放。
- **一致性**：数据库与文件系统的事务一致性。